services:
  # 1. Web Service (Flask API + Scraper)
  - type: web
    name: br-statistics-api
    runtime: docker
    plan: starter
    region: oregon
    numInstances: 1
    envVars:
      - key: FLASK_APP
        value: api_app.py
      - key: FLASK_ENV
        value: production
      - key: SECRET_KEY
        generateValue: true
      - key: DATABASE_URL
        fromDatabase:
          name: br-stats-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          type: redis
          name: br-stats-queue
          property: connectionString
      - key: REDIS_HOST
        fromService:
          type: redis
          name: br-stats-queue
          property: host
      - key: REDIS_PORT
        fromService:
          type: redis
          name: br-stats-queue
          property: port
      - key: PLAYWRIGHT_BROWSERS_PATH
        value: /ms-playwright

  # 2. Celery Worker (Background Scraper)
  - type: worker
    name: br-statistics-worker
    runtime: docker
    plan: starter
    region: oregon
    numInstances: 1
    startCommand: "celery -A app.celery_app worker --loglevel=info --concurrency=1"
    envVars:
      - key: FLASK_APP
        value: api_app.py
      - key: FLASK_ENV
        value: production
      - key: SECRET_KEY
        generateValue: true
      - key: DATABASE_URL
        fromDatabase:
          name: br-stats-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          type: redis
          name: br-stats-queue
          property: connectionString
      - key: REDIS_HOST
        fromService:
          type: redis
          name: br-stats-queue
          property: host
      - key: REDIS_PORT
        fromService:
          type: redis
          name: br-stats-queue
          property: port
      - key: PLAYWRIGHT_BROWSERS_PATH
        value: /ms-playwright

databases:
  # 2. Managed PostgreSQL
  - name: br-stats-db
    plan: free # or starter
    databaseName: brasileirao_2026
    user: br_user

  # 3. Managed Redis
  - name: br-stats-queue
    plan: free # or starter
    ipAllowList: [] # Allow only internal connections
